<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Room</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <div class="wrapper">
      <h1>Welcome to the Game Room</h1>
      <p>Your nickname: <strong id="nickname">{{nickname}}</strong></p>

      <h2>Connected Users:</h2>
      <ul id="userList"></ul>

      <h2>Red Team:</h2>
      <p id="redLeader">Leader: None</p>
      <ul id="redTeamList"></ul>

      <h2>Blue Team:</h2>
      <p id="blueLeader">Leader: None</p>
      <ul id="blueTeamList"></ul>

      <button class="team-btn red-item" id="redLeaderButton">ðŸ”´ðŸ‘‘<br>Become Red Leader</button>
      <button class="team-btn blue-item" id="blueLeaderButton">ðŸ”µðŸ‘‘<br>Become Blue Leader</button>
      <br><br>
      <button class="team-btn red-item" id="redJoinButton">ðŸ”´<br>Join Red</button>
      <button class="team-btn blue-item" id="blueJoinButton">ðŸ”µ<br>Join Blue</button>
      <br><br>
      <button id="leaveRoomButton">Leave Room</button>
    </div>

    <script>
      const nickname = document.getElementById("nickname").innerText;
      const userList = document.getElementById("userList");
      const redLeaderDisplay = document.getElementById("redLeader");
      const blueLeaderDisplay = document.getElementById("blueLeader");
      const redTeamList = document.getElementById("redTeamList");
      const blueTeamList = document.getElementById("blueTeamList");
      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
      const ws = new WebSocket(`${protocol}://${window.location.host}`);

      // Send join event on WebSocket connection
      ws.addEventListener("open", () => {
        console.log("WebSocket connected. Sending join event.");
        ws.send(JSON.stringify({ type: "join", nickname }));
      });

      // Handle incoming WebSocket messages
      ws.addEventListener("message", (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "updateUsers") {
          console.log("Updating user list, leaders, and teams:", data);

          // Update user list
          userList.innerHTML = ""; // Clear the current list
          data.activeUsers.forEach((user) => {
            const li = document.createElement("li");
            li.innerText = user; // Add each user to the list
            userList.appendChild(li);
          });

          // Update Red Leader and Team
          redLeaderDisplay.innerText = `Leader: ${data.redLeader || "None"}`;
          redTeamList.innerHTML = ""; // Clear the current list
          data.redTeamUsers.forEach((user, index) => {
            const li = document.createElement("li");
            li.innerText = `${index + 1}. ${user}`;
            redTeamList.appendChild(li);
          });

          // Update Blue Leader and Team
          blueLeaderDisplay.innerText = `Leader: ${data.blueLeader || "None"}`;
          blueTeamList.innerHTML = ""; // Clear the current list
          data.blueTeamUsers.forEach((user, index) => {
            const li = document.createElement("li");
            li.innerText = `${index + 1}. ${user}`;
            blueTeamList.appendChild(li);
          });
        }
      });

      // Event listeners for buttons
      document.getElementById("leaveRoomButton").addEventListener("click", () => {
        console.log("Leaving the room.");
        ws.send(JSON.stringify({ type: "leave", nickname }));
        window.location.href = "/";
      });

      document.getElementById("redLeaderButton").addEventListener("click", () => {
        console.log(`${nickname} wants to become Red Leader.`);
        ws.send(JSON.stringify({ type: "redLeader", nickname }));
      });

      document.getElementById("blueLeaderButton").addEventListener("click", () => {
        console.log(`${nickname} wants to become Blue Leader.`);
        ws.send(JSON.stringify({ type: "blueLeader", nickname }));
      });

      document.getElementById("redJoinButton").addEventListener("click", () => {
        console.log(`${nickname} wants to join red.`);
        ws.send(JSON.stringify({ type: "redJoin", nickname }));
      });

      document.getElementById("blueJoinButton").addEventListener("click", () => {
        console.log(`${nickname} wants to join blue.`);
        ws.send(JSON.stringify({ type: "blueJoin", nickname }));
      });

      // Notify server on page unload
      window.addEventListener("beforeunload", () => {
        ws.send(JSON.stringify({ type: "leave", nickname }));
      });
      
    </script>
  </body>
</html>
